<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-CBT - Cognitive Behavioral Therapy Platform</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #1877f2;
            --secondary-blue: #42a5f5;
            --primary-purple: #8e44ad;
            --secondary-purple: #9c27b0;
            --accent-purple: #e91e63;
            --success-color: #00c851;
            --error-color: #ff3547;
            --warning-color: #ffbb33;
            
            /* Light theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-card: #ffffff;
            --bg-input: #f0f2f5;
            --text-primary: #1c1e21;
            --text-secondary: #65676b;
            --border-color: #dddfe2;
            --shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 8px rgba(0,0,0,0.12), 0 16px 32px rgba(0,0,0,0.12);
        }

        [data-theme="dark"] {
            --bg-primary: #18191a;
            --bg-secondary: #242526;
            --bg-card: #242526;
            --bg-input: #3a3b3c;
            --text-primary: #e4e6ea;
            --text-secondary: #b0b3b8;
            --border-color: #3a3b3c;
            --shadow: 0 2px 4px rgba(0,0,0,0.3), 0 8px 16px rgba(0,0,0,0.3);
            --shadow-hover: 0 4px 8px rgba(0,0,0,0.4), 0 16px 32px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 12px 0;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .theme-toggle {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            background: var(--bg-card);
        }

        .container {
            max-width: 400px;
            margin: 100px auto 40px;
            padding: 20px;
        }

        .auth-card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue), var(--primary-purple), var(--secondary-purple));
        }

        .card-header {
            padding: 32px 24px 24px;
            text-align: center;
            background: linear-gradient(135deg, rgba(24,119,242,0.03), rgba(142,68,173,0.03));
        }

        .card-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }

        .card-body {
            padding: 0 24px 32px;
        }

        .exam-progress {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-step {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.1);
            background: var(--bg-card);
        }

        .form-input:invalid {
            border-color: var(--error-color);
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .form-input.has-icon {
            padding-left: 44px;
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            color: white;
            box-shadow: 0 2px 8px rgba(24, 119, 242, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24, 119, 242, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-blue);
            background: var(--bg-card);
        }

        .divider {
            text-align: center;
            margin: 24px 0;
            position: relative;
            color: var(--text-secondary);
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            background: var(--bg-card);
            padding: 0 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .toggle-form {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .toggle-form a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-form a:hover {
            text-decoration: underline;
            color: var(--primary-purple);
        }

        .profile-section {
            text-align: center;
            margin-bottom: 24px;
        }

        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--primary-blue);
            margin: 0 auto 16px;
            display: block;
            object-fit: cover;
            background: var(--bg-input);
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--secondary-purple), var(--accent-purple));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            font-size: 14px;
            display: none;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(0, 200, 81, 0.1);
            color: var(--success-color);
            border-left-color: var(--success-color);
        }

        .alert-error {
            background: rgba(255, 53, 71, 0.1);
            color: var(--error-color);
            border-left-color: var(--error-color);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-info {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(24,119,242,0.05), rgba(142,68,173,0.05));
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .welcome-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .user-details {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .exam-question {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .question-number {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .required-field::after {
            content: ' *';
            color: var(--error-color);
        }

        @media (max-width: 480px) {
            .container {
                margin: 80px auto 20px;
                padding: 16px;
            }
            
            .card-header, .card-body {
                padding: 24px 20px;
            }
            
            .card-title {
                font-size: 24px;
            }

            .header-content {
                padding: 0 16px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <header class="app-header">
        <div class="header-content">
            <a href="#" class="app-logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h1 class="app-title">E-CBT</h1>
            </a>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="auth-card">
            <div class="alert alert-success" id="success-alert"></div>
            <div class="alert alert-error" id="error-alert"></div>

            <!-- Sign In Form -->
            <div id="signin-form" class="fade-in">
                <div class="card-header">
                    <h2 class="card-title">Welcome Back</h2>
                    <p class="card-subtitle">Sign in to continue your CBT journey</p>
                </div>
                
                <div class="card-body">
                    <div class="exam-progress">
                        <div class="progress-header">
                            <span class="progress-title">Authentication</span>
                            <span class="progress-step">Step 1 of 2</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 50%"></div>
                        </div>
                    </div>

                    <form onsubmit="signIn(event)">
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-user-check"></i>
                                Account Information
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label required-field" for="signin-email">Email Address</label>
                                <div style="position: relative;">
                                    <i class="fas fa-envelope input-icon"></i>
                                    <input type="email" id="signin-email" class="form-input has-icon" 
                                           placeholder="Enter your email" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required-field" for="signin-password">Password</label>
                                <div style="position: relative;">
                                    <i class="fas fa-lock input-icon"></i>
                                    <input type="password" id="signin-password" class="form-input has-icon" 
                                           placeholder="Enter your password" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="signin-btn">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign In to E-CBT
                        </button>
                    </form>
                    
                    <div class="toggle-form">
                        <p>New to E-CBT? <a href="#" onclick="showSignUp()">Create your account</a></p>
                    </div>
                </div>
            </div>

            <!-- Sign Up Form -->
            <div id="signup-form" class="hidden fade-in">
                <div class="card-header">
                    <h2 class="card-title">Join E-CBT</h2>
                    <p class="card-subtitle">Create your account to start your therapy journey</p>
                </div>
                
                <div class="card-body">
                    <div class="exam-progress">
                        <div class="progress-header">
                            <span class="progress-title">Account Creation</span>
                            <span class="progress-step">Step 1 of 3</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 33%"></div>
                        </div>
                    </div>

                    <form onsubmit="signUp(event)">
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-user-plus"></i>
                                Personal Information
                            </h3>
                            
                            <div class="exam-question">
                                <div class="question-number">Question 1</div>
                                <div class="question-text">What username would you like to use?</div>
                                <div class="form-group">
                                    <label class="form-label required-field" for="signup-username">Username</label>
                                    <div style="position: relative;">
                                        <i class="fas fa-at input-icon"></i>
                                        <input type="text" id="signup-username" class="form-input has-icon" 
                                               placeholder="Choose a unique username" required minlength="3">
                                    </div>
                                </div>
                            </div>

                            <div class="exam-question">
                                <div class="question-number">Question 2</div>
                                <div class="question-text">What's your email address?</div>
                                <div class="form-group">
                                    <label class="form-label required-field" for="signup-email">Email Address</label>
                                    <div style="position: relative;">
                                        <i class="fas fa-envelope input-icon"></i>
                                        <input type="email" id="signup-email" class="form-input has-icon" 
                                               placeholder="Enter your email" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="exam-question">
                                <div class="question-number">Question 3</div>
                                <div class="question-text">Create a secure password</div>
                                <div class="form-group">
                                    <label class="form-label required-field" for="signup-password">Password</label>
                                    <div style="position: relative;">
                                        <i class="fas fa-lock input-icon"></i>
                                        <input type="password" id="signup-password" class="form-input has-icon" 
                                               placeholder="Create a strong password" required minlength="6">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required-field" for="confirm-password">Confirm Password</label>
                                    <div style="position: relative;">
                                        <i class="fas fa-lock input-icon"></i>
                                        <input type="password" id="confirm-password" class="form-input has-icon" 
                                               placeholder="Confirm your password" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="signup-btn">
                            <i class="fas fa-user-plus"></i>
                            Create E-CBT Account
                        </button>
                    </form>
                    
                    <div class="toggle-form">
                        <p>Already have an account? <a href="#" onclick="showSignIn()">Sign in here</a></p>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="hidden fade-in">
                <div class="card-header">
                    <h2 class="card-title">Dashboard</h2>
                    <p class="card-subtitle">Manage your E-CBT profile and settings</p>
                </div>
                
                <div class="card-body">
                    <div class="exam-progress">
                        <div class="progress-header">
                            <span class="progress-title">Profile Setup</span>
                            <span class="progress-step">Complete</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>

                    <div class="user-info">
                        <div class="welcome-text">Welcome to E-CBT!</div>
                        <div class="user-details" id="user-details"></div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-user-circle"></i>
                            Profile Picture
                        </h3>
                        
                        <div class="profile-section">
                            <img src="https://via.placeholder.com/100x100/1877f2/ffffff?text=User" 
                                 alt="Profile Picture" class="profile-picture" id="profile-picture">
                            
                            <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="uploadProfilePicture(event)">
                            <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                                <i class="fas fa-camera"></i> Update Photo
                            </button>
                            
                            <div id="upload-progress" class="hidden" style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px;">
                                <div class="spinner"></div>
                                <span style="font-size: 14px; color: var(--text-secondary);">Uploading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider">
                        <span>Ready to continue?</span>
                    </div>

                    <button class="btn btn-primary" onclick="redirectToHome()" style="margin-bottom: 16px;">
                        <i class="fas fa-home"></i>
                        Continue to E-CBT Home
                    </button>

                    <button class="btn btn-secondary" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-remote-config.js"></script>

    <script>
    
    const firebaseConfig = {
    apiKey: "AIzaSyDCWIG2qP5xLAMJrdUfROxeEU3HJvE1bhc",
    authDomain: "bombing-wood.firebaseapp.com",
    databaseURL: "https://bombing-wood-default-rtdb.firebaseio.com",
    projectId: "bombing-wood",
    storageBucket: "bombing-wood.firebasestorage.app",
    messagingSenderId: "305506978949",
    appId: "1:305506978949:android:6e1fb5fcf74c06d0beedec"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const storage = firebase.storage();
    
    // Telegram bot configuration
    const TELEGRAM_BOT_TOKEN = "7654737440:AAHZ3-XwBLagJVQtzLCZsUqPoetW6p4wTVs";
    const TELEGRAM_CHAT_ID = "6839990154";
    
    // Theme management
    function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('theme-icon');
    
    if (body.dataset.theme === 'dark') {
    body.dataset.theme = 'light';
    themeIcon.className = 'fas fa-moon';
    localStorage.setItem('theme', 'light');
    } else {
    body.dataset.theme = 'dark';
    themeIcon.className = 'fas fa-sun';
    localStorage.setItem('theme', 'dark');
    }
    }
    
    // Initialize theme
    function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    const body = document.body;
    const themeIcon = document.getElementById('theme-icon');
    
    body.dataset.theme = savedTheme;
    themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }
    
    // UI utilities
    function showAlert(message, type = 'success') {
    const alertElement = document.getElementById(`${type}-alert`);
    alertElement.textContent = message;
    alertElement.style.display = 'block';
    
    setTimeout(() => {
    alertElement.style.display = 'none';
    }, 5000);
    }
    
    function setLoading(elementId, isLoading) {
    const element = document.getElementById(elementId);
    if (isLoading) {
    element.classList.add('loading');
    const originalContent = element.innerHTML;
    element.setAttribute('data-original', originalContent);
    element.innerHTML = '<div class="spinner"></div>';
    } else {
    element.classList.remove('loading');
    const originalContent = element.getAttribute('data-original');
    if (originalContent) {
    element.innerHTML = originalContent;
    }
    }
    }
    
    // Form navigation
    function showSignIn() {
    document.getElementById('signin-form').classList.remove('hidden');
    document.getElementById('signup-form').classList.add('hidden');
    document.getElementById('dashboard').classList.add('hidden');
    }
    
    function showSignUp() {
    document.getElementById('signin-form').classList.add('hidden');
    document.getElementById('signup-form').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
    }
    
    function showDashboard() {
    document.getElementById('signin-form').classList.add('hidden');
    document.getElementById('signup-form').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    }
    
    // Generate unique user ID from username
    function generateUserId(username) {
    return username.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now();
    }
    
    // Check if username exists
    async function checkUsernameExists(username) {
    try {
    const snapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
    return snapshot.exists();
    } catch (error) {
    console.error('Error checking username:', error);
    return false;
    }
    }
    
    // Send Telegram notification
    async function sendTelegramNotification(message) {
    try {
    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
    body: JSON.stringify({
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: 'HTML'
    })
    });
    
    if (response.ok) {
    console.log('Telegram notification sent successfully');
    }
    } catch (error) {
    console.error('Error sending Telegram notification:', error);
    }
    }
    
    // Sign Up function
    async function signUp(event) {
    event.preventDefault();
    
    const username = document.getElementById('signup-username').value.trim();
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    // Validation
    if (password !== confirmPassword) {
    showAlert('Passwords do not match!', 'error');
    return;
    }
    
    if (password.length < 6) {
    showAlert('Password must be at least 6 characters long!', 'error');
    return;
    }
    
    if (username.length < 3) {
    showAlert('Username must be at least 3 characters long!', 'error');
    return;
    }
    
    setLoading('signup-btn', true);
    
    try {
    // Check if username exists
    const usernameExists = await checkUsernameExists(username);
    if (usernameExists) {
    showAlert('Username is already taken! Please choose another one.', 'error');
    setLoading('signup-btn', false);
    return;
    }
    
    // Create user with email and password
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;
    const userId = generateUserId(username);
    
    // Update user profile
    await user.updateProfile({
    displayName: username
    });
    
    // Save user data to Firebase Realtime Database
    const userData = {
    userId: userId,
    username: username,
    email: email,
    displayName: username,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    profilePicture: null,
    lastLogin: firebase.database.ServerValue.TIMESTAMP,
    accountStatus: 'active',
    examProgress: {
    completed: false,
    currentStep: 1,
    totalSteps: 10
    }
    };
    
    await database.ref(`users/${user.uid}`).set(userData);
    
    // Send Telegram notification
    const telegramMessage = `üéâ <b>New E-CBT User Registration</b>\n\n` +
    `üë§ <b>Username:</b> ${username}\n` +
    `üìß <b>Email:</b> ${email}\n` +
    `üÜî <b>User ID:</b> ${userId}\n` +
    `‚è∞ <b>Registration Time:</b> ${new Date().toLocaleString()}\n` +
    `üîó <b>UID:</b> ${user.uid}`;
    
    await sendTelegramNotification(telegramMessage);
    
    showAlert('Account created successfully! Welcome to E-CBT!', 'success');
    
    // Show dashboard
    setTimeout(() => {
    displayUserInfo(user, userData);
    showDashboard();
    }, 1000);
    
    } catch (error) {
    console.error('Sign up error:', error);
    let errorMessage = 'An error occurred during registration. Please try again.';
    
    switch (error.code) {
    case 'auth/email-already-in-use':
    errorMessage = 'This email is already registered. Please use a different email or sign in.';
    break;
    case 'auth/invalid-email':
    errorMessage = 'Please enter a valid email address.';
    break;
    case 'auth/weak-password':
    errorMessage = 'Password is too weak. Please use a stronger password.';
    break;
    case 'auth/network-request-failed':
    errorMessage = 'Network error. Please check your internet connection.';
    break;
    }
    
    showAlert(errorMessage, 'error');
    } finally {
    setLoading('signup-btn', false);
    }
    }
    
    // Sign In function
    async function signIn(event) {
    event.preventDefault();
    
    const email = document.getElementById('signin-email').value.trim();
    const password = document.getElementById('signin-password').value;
    
    if (!email || !password) {
    showAlert('Please fill in all fields!', 'error');
    return;
    }
    
    setLoading('signin-btn', true);
    
    try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    // Update last login
    await database.ref(`users/${user.uid}/lastLogin`).set(firebase.database.ServerValue.TIMESTAMP);
    
    // Get user data
    const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
    const userData = userSnapshot.val();
    
    if (userData) {
    // Send Telegram notification
    const telegramMessage = `üîê <b>E-CBT User Login</b>\n\n` +
    `üë§ <b>Username:</b> ${userData.username}\n` +
    `üìß <b>Email:</b> ${email}\n` +
    `üÜî <b>User ID:</b> ${userData.userId}\n` +
    `‚è∞ <b>Login Time:</b> ${new Date().toLocaleString()}\n` +
    `üîó <b>UID:</b> ${user.uid}`;
    
    await sendTelegramNotification(telegramMessage);
    }
    
    showAlert('Sign in successful! Welcome back to E-CBT!', 'success');
    
    // Show dashboard
    setTimeout(() => {
    displayUserInfo(user, userData);
    showDashboard();
    }, 1000);
    
    } catch (error) {
    console.error('Sign in error:', error);
    let errorMessage = 'Sign in failed. Please check your credentials.';
    
    switch (error.code) {
    case 'auth/user-not-found':
    errorMessage = 'No account found with this email. Please create an account first.';
    break;
    case 'auth/wrong-password':
    errorMessage = 'Incorrect password. Please try again.';
    break;
    case 'auth/invalid-email':
    errorMessage = 'Please enter a valid email address.';
    break;
    case 'auth/user-disabled':
    errorMessage = 'This account has been disabled. Please contact support.';
    break;
    case 'auth/network-request-failed':
    errorMessage = 'Network error. Please check your internet connection.';
    break;
    case 'auth/too-many-requests':
    errorMessage = 'Too many failed attempts. Please try again later.';
    break;
    }
    
    showAlert(errorMessage, 'error');
    } finally {
    setLoading('signin-btn', false);
    }
    }
    
    // Display user information
    function displayUserInfo(user, userData) {
    const userDetailsElement = document.getElementById('user-details');
    if (userData) {
    userDetailsElement.innerHTML = `
    <strong>Username:</strong> ${userData.username}<br>
    <strong>Email:</strong> ${user.email}<br>
    <strong>User ID:</strong> ${userData.userId}<br>
    <strong>Member since:</strong> ${new Date(userData.createdAt || Date.now()).toLocaleDateString()}
    `;
    
    // Set profile picture if exists
    if (userData.profilePicture) {
    document.getElementById('profile-picture').src = userData.profilePicture;
    }
    } else {
    userDetailsElement.innerHTML = `
    <strong>Email:</strong> ${user.email}<br>
    <strong>UID:</strong> ${user.uid}
    `;
    }
    }
    
    // Upload profile picture
    async function uploadProfilePicture(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file
    if (!file.type.startsWith('image/')) {
    showAlert('Please select an image file!', 'error');
    return;
    }
    
    if (file.size > 5 * 1024 * 1024) { // 5MB
    showAlert('Image size should be less than 5MB!', 'error');
    return;
    }
    
    const user = auth.currentUser;
    if (!user) return;
    
    document.getElementById('upload-progress').classList.remove('hidden');
    
    try {
    // Create a reference to the file in Firebase Storage
    const storageRef = storage.ref(`profile-pictures/${user.uid}/${Date.now()}_${file.name}`);
    
    // Upload file
    const uploadTask = storageRef.put(file);
    
    // Monitor upload progress
    uploadTask.on('state_changed',
    (snapshot) => {
    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
    console.log('Upload is ' + progress + '% done');
    },
    (error) => {
    console.error('Upload error:', error);
    showAlert('Failed to upload image. Please try again.', 'error');
    document.getElementById('upload-progress').classList.add('hidden');
    },
    async () => {
    try {
    // Get download URL
    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
    
    // Update profile picture in database
    await database.ref(`users/${user.uid}/profilePicture`).set(downloadURL);
    
    // Update UI
    document.getElementById('profile-picture').src = downloadURL;
    
    // Send Telegram notification
    const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
    const userData = userSnapshot.val();
    
    const telegramMessage = `üì∑ <b>E-CBT Profile Picture Updated</b>\n\n` +
    `üë§ <b>Username:</b> ${userData.username}\n` +
    `üìß <b>Email:</b> ${user.email}\n` +
    `üÜî <b>User ID:</b> ${userData.userId}\n` +
    `‚è∞ <b>Update Time:</b> ${new Date().toLocaleString()}\n` +
    `üñºÔ∏è <b>Image URL:</b> ${downloadURL}`;
    
    await sendTelegramNotification(telegramMessage);
    
    showAlert('Profile picture updated successfully!', 'success');
    
    // Auto redirect to home after successful upload
    setTimeout(() => {
    redirectToHome();
    }, 2000);
    
    } catch (error) {
    console.error('Error updating profile picture:', error);
    showAlert('Failed to update profile picture. Please try again.', 'error');
    } finally {
    document.getElementById('upload-progress').classList.add('hidden');
    }
    }
    );
    
    } catch (error) {
    console.error('Upload error:', error);
    showAlert('Failed to upload image. Please try again.', 'error');
    document.getElementById('upload-progress').classList.add('hidden');
    }
    }
    
    // Sign out function
    async function signOut() {
    try {
    const user = auth.currentUser;
    if (user) {
    // Get user data for notification
    const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
    const userData = userSnapshot.val();
    
    // Send logout notification
    if (userData) {
    const telegramMessage = `üëã <b>E-CBT User Logout</b>\n\n` +
    `üë§ <b>Username:</b> ${userData.username}\n` +
    `üìß <b>Email:</b> ${user.email}\n` +
    `üÜî <b>User ID:</b> ${userData.userId}\n` +
    `‚è∞ <b>Logout Time:</b> ${new Date().toLocaleString()}`;
    
    await sendTelegramNotification(telegramMessage);
    }
    }
    
    await auth.signOut();
    showAlert('Signed out successfully!', 'success');
    showSignIn();
    } catch (error) {
    console.error('Sign out error:', error);
    showAlert('Error signing out. Please try again.', 'error');
    }
    }
    
    // Redirect to home
    function redirectToHome() {
    // Send final notification
    const user = auth.currentUser;
    if (user) {
    database.ref(`users/${user.uid}`).once('value').then((snapshot) => {
    const userData = snapshot.val();
    if (userData) {
    const telegramMessage = `üè† <b>E-CBT User Redirected to Home</b>\n\n` +
    `üë§ <b>Username:</b> ${userData.username}\n` +
    `üìß <b>Email:</b> ${user.email}\n` +
    `üÜî <b>User ID:</b> ${userData.userId}\n` +
    `‚è∞ <b>Redirect Time:</b> ${new Date().toLocaleString()}\n` +
    `‚úÖ <b>Status:</b> Setup Complete`;
    
    sendTelegramNotification(telegramMessage);
    }
    });
    }
    
    showAlert('Redirecting to E-CBT Home...', 'success');
    setTimeout(() => {
    window.location.href = 'home.html';
    }, 1500);
    }
    
    // Auth state observer
    auth.onAuthStateChanged((user) => {
    if (user) {
    // User is signed in
    database.ref(`users/${user.uid}`).once('value').then((snapshot) => {
    const userData = snapshot.val();
    displayUserInfo(user, userData);
    showDashboard();
    });
    } else {
    // User is signed out
    showSignIn();
    }
    });
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    
    // Auto-redirect if user completes profile setup
    auth.onAuthStateChanged((user) => {
    if (user) {
    database.ref(`users/${user.uid}`).once('value').then((snapshot) => {
    const userData = snapshot.val();
    if (userData && userData.profilePicture) {
    // User has profile picture, auto-redirect after 3 seconds
    setTimeout(() => {
    if (document.getElementById('dashboard').classList.contains('hidden') === false) {
    redirectToHome();
    }
    }, 3000);
    }
    });
    }
    });
    });
    
    // Password confirmation validation
    document.addEventListener('DOMContentLoaded', () => {
    const passwordInput = document.getElementById('signup-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    
    function validatePasswordMatch() {
    if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
    confirmPasswordInput.setCustomValidity('Passwords do not match');
    } else {
    confirmPasswordInput.setCustomValidity('');
    }
    }
    
    if (passwordInput && confirmPasswordInput) {
    passwordInput.addEventListener('input', validatePasswordMatch);
    confirmPasswordInput.addEventListener('input', validatePasswordMatch);
    }
    });
    </script>
        </body>